{"version":3,"file":"cache.service.js","sourceRoot":"","sources":["../src/cache.service.ts"],"names":[],"mappings":"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","sourcesContent":["import { Injectable } from '@angular/core';\r\nimport { HttpResponse } from '@angular/common/http';\r\nimport { Observable, Subject } from 'rxjs';\r\nimport { defer, from, fromEvent, merge, throwError } from 'rxjs';\r\nimport { share, map, catchError } from 'rxjs/operators';\r\nimport { CacheStorageService, StorageCacheItem } from './cache-storage';\r\n\r\nexport interface CacheConfig {\r\n  keyPrefix?: string;\r\n}\r\n\r\nexport const MESSAGES = {\r\n  0: 'Cache initialization error: ',\r\n  1: 'Cache is not enabled.',\r\n  2: 'Cache entry already expired: ',\r\n  3: 'No such key: ',\r\n  4: 'No entries were deleted, because browser is offline.'\r\n};\r\n\r\nexport type CacheValueFactory<T> = () => Promise<T>;\r\n\r\n/**\r\n * @description Check if it's an HttpResponse\r\n * @param {any} data - Variable to test\r\n * @return {boolean} - data from cache\r\n */\r\nconst isHttpResponse = (data: any): boolean => {\r\n  let orCondition =\r\n    data &&\r\n    typeof data === 'object' &&\r\n    data.hasOwnProperty('status') &&\r\n    data.hasOwnProperty('statusText') &&\r\n    data.hasOwnProperty('headers') &&\r\n    data.hasOwnProperty('url') &&\r\n    data.hasOwnProperty('body');\r\n\r\n  return data && (data instanceof HttpResponse || orCondition);\r\n};\r\n\r\n@Injectable()\r\nexport class CacheService {\r\n  private ttl: number = 60 * 60; // one hour\r\n  private cacheEnabled: boolean = true;\r\n  private invalidateOffline: boolean = false;\r\n  private networkStatusChanges: Observable<boolean>;\r\n  private networkStatus: boolean = true;\r\n\r\n  constructor(\r\n    private _storage: CacheStorageService\r\n  ) {\r\n    this.watchNetworkInit();\r\n    this.loadCache();\r\n  }\r\n\r\n  private async loadCache() {\r\n    try {\r\n      await this._storage.ready();\r\n      this.cacheEnabled = true;\r\n    } catch (e) {\r\n      this.cacheEnabled = false;\r\n      console.error(MESSAGES[0], e);\r\n    }\r\n  }\r\n\r\n  async ready(): Promise<any> {\r\n    await this._storage.ready();\r\n  }\r\n\r\n  /**\r\n   * @description Disable or enable cache\r\n   */\r\n  enableCache(enable: boolean = true) {\r\n    this.cacheEnabled = enable;\r\n  }\r\n\r\n  /**\r\n   * @description Delete DB table and create new one\r\n   * @return {Promise<any>}\r\n   */\r\n  private async resetDatabase(): Promise<any> {\r\n    await this.ready();\r\n\r\n    let items = await this._storage.all();\r\n    return Promise.all(\r\n      items\r\n      .map(item => this.removeItem(item.key))\r\n    );\r\n  }\r\n\r\n  /**\r\n   * @description Set default TTL\r\n   * @param {number} ttl - TTL in seconds\r\n   */\r\n  setDefaultTTL(ttl: number): number {\r\n    return (this.ttl = ttl);\r\n  }\r\n\r\n  /**\r\n   * @description Set if expired cache should be invalidated if device is offline\r\n   * @param {boolean} offlineInvalidate\r\n   */\r\n  setOfflineInvalidate(offlineInvalidate: boolean) {\r\n    this.invalidateOffline = !offlineInvalidate;\r\n  }\r\n\r\n  /**\r\n   * @description Start watching if devices is online or offline\r\n   */\r\n  private watchNetworkInit() {\r\n    this.networkStatus = navigator.onLine;\r\n    const connect = fromEvent(window, 'online').pipe(map(() => true)),\r\n      disconnect = fromEvent(window, 'offline').pipe(map(() => false));\r\n\r\n    this.networkStatusChanges = merge(connect, disconnect).pipe(share());\r\n    this.networkStatusChanges.subscribe(status => {\r\n      this.networkStatus = status;\r\n    });\r\n  }\r\n\r\n  /**\r\n   * @description Stream of network status changes\r\n   * * @return {Observable<boolean>} network status stream\r\n   */\r\n  getNetworkStatusChanges() {\r\n    return this.networkStatusChanges;\r\n  }\r\n\r\n  /**\r\n   * @description Check if devices is online\r\n   * @return {boolean} network status\r\n   */\r\n  isOnline() {\r\n    return this.networkStatus;\r\n  }\r\n\r\n  /**\r\n   * @description Save item to cache\r\n   * @param {string} key - Unique key\r\n   * @param {any} data - Data to store\r\n   * @param {string} [groupKey] - group key\r\n   * @param {number} [ttl] - TTL in seconds\r\n   * @return {Promise<any>} - saved data\r\n   */\r\n  saveItem(\r\n    key: string,\r\n    data: any,\r\n    groupKey: string = 'none',\r\n    ttl: number = this.ttl\r\n  ): Promise<any> {\r\n    if (!this.cacheEnabled) {\r\n      throw new Error(MESSAGES[1]);\r\n    }\r\n\r\n    const expires = new Date().getTime() + ttl * 1000,\r\n      type = isHttpResponse(data) ? 'response' : typeof data,\r\n      value = JSON.stringify(data);\r\n\r\n    return this._storage.set(key, {\r\n      value,\r\n      expires,\r\n      type,\r\n      groupKey\r\n    });\r\n  }\r\n\r\n  /**\r\n   * @description Delete item from cache\r\n   * @param {string} key - Unique key\r\n   * @return {Promise<any>} - query execution promise\r\n   */\r\n  removeItem(key: string): Promise<any> {\r\n    if (!this.cacheEnabled) {\r\n      throw new Error(MESSAGES[1]);\r\n    }\r\n\r\n    return this._storage.remove(key);\r\n  }\r\n\r\n  /**\r\n   * @description Removes all items with a key that matches pattern\r\n   * @return {Promise<any>}\r\n   */\r\n  async removeItems(pattern: string): Promise<any> {\r\n    if (!this.cacheEnabled) {\r\n      throw new Error(MESSAGES[1]);\r\n    }\r\n\r\n    let regex = new RegExp(`^${pattern.split('*').join('.*')}$`);\r\n    let items = await this._storage.all();\r\n\r\n    return Promise.all(\r\n      items\r\n      .map(item => item.key)\r\n      .filter(key => key && regex.test(key))\r\n      .map(key => this.removeItem(key))\r\n    );\r\n  }\r\n\r\n  /**\r\n   * @description Get item from cache without expire check etc.\r\n   * @param {string} key - Unique key\r\n   * @return {Promise<any>} - data from cache\r\n   */\r\n  async getRawItem<T = any>(key: string): Promise<StorageCacheItem> {\r\n    if (!this.cacheEnabled) {\r\n      throw new Error(MESSAGES[1]);\r\n    }\r\n\r\n    try {\r\n      let data = await this._storage.get(key);\r\n      if (!!data) {\r\n        return data;\r\n      }\r\n\r\n      throw new Error('');\r\n    } catch (err) {\r\n      throw new Error(MESSAGES[3] + key);\r\n    }\r\n  }\r\n\r\n  async getRawItems() {\r\n    return this._storage.all();\r\n  }\r\n\r\n  /**\r\n   * @description Check if item exists in cache regardless if expired or not\r\n   * @param {string} key - Unique key\r\n   * @return {Promise<boolean | string>} - boolean - true if exists\r\n   */\r\n  async itemExists(key: string): Promise<boolean | string> {\r\n    if (!this.cacheEnabled) {\r\n      throw new Error(MESSAGES[1]);\r\n    }\r\n\r\n    return this._storage.exists(key);\r\n  }\r\n\r\n  /**\r\n   * @description Get item from cache with expire check and correct type assign\r\n   * @param {string} key - Unique key\r\n   * @return {Promise<any>} - data from cache\r\n   */\r\n  async getItem<T = any>(key: string): Promise<T> {\r\n    if (!this.cacheEnabled) {\r\n      throw new Error(MESSAGES[1]);\r\n    }\r\n\r\n    let data = await this.getRawItem(key);\r\n\r\n    if (data.expires < new Date().getTime() && (this.invalidateOffline || this.isOnline())) {\r\n      throw new Error(MESSAGES[2] + key);\r\n    }\r\n\r\n    return CacheService.decodeRawData(data);\r\n  }\r\n\r\n  async getOrSetItem<T>(\r\n    key: string,\r\n    factory: CacheValueFactory<T>,\r\n    groupKey?: string,\r\n    ttl?: number\r\n  ): Promise<T> {\r\n    let val: T;\r\n\r\n    try {\r\n      val = await this.getItem<T>(key);\r\n    } catch (error) {\r\n      val = await factory();\r\n      await this.saveItem(key, val, groupKey, ttl);\r\n    }\r\n\r\n    return val;\r\n  }\r\n\r\n  /**\r\n   * @description Decode raw data from DB\r\n   * @param {any} data - Data\r\n   * @return {any} - decoded data\r\n   */\r\n  static decodeRawData(data: StorageCacheItem): any {\r\n    let dataJson = JSON.parse(data.value);\r\n    if (isHttpResponse(dataJson)) {\r\n      let response: any = {\r\n        body: dataJson._body || dataJson.body,\r\n        status: dataJson.status,\r\n        headers: dataJson.headers,\r\n        statusText: dataJson.statusText,\r\n        url: dataJson.url\r\n      };\r\n\r\n      return new HttpResponse(response);\r\n    }\r\n\r\n    return dataJson;\r\n  }\r\n\r\n  /**\r\n   * @description Load item from cache if it's in cache or load from origin observable\r\n   * @param {string} key - Unique key\r\n   * @param {any} observable - Observable with data\r\n   * @param {string} [groupKey] - group key\r\n   * @param {number} [ttl] - TTL in seconds\r\n   * @return {Observable<any>} - data from cache or origin observable\r\n   */\r\n  loadFromObservable<T = any>(\r\n    key: string,\r\n    observable: any,\r\n    groupKey?: string,\r\n    ttl?: number\r\n  ): Observable<T> {\r\n    if (!this.cacheEnabled) return observable;\r\n\r\n    observable = observable.pipe(share());\r\n\r\n    return defer(() => {\r\n      return from(this.getItem(key)).pipe(\r\n        catchError(e => {\r\n          observable.subscribe(\r\n            res => {\r\n              return this.saveItem(key, res, groupKey, ttl);\r\n            },\r\n            error => {\r\n              return throwError(error);\r\n            }\r\n          );\r\n\r\n          return observable;\r\n        })\r\n      );\r\n    });\r\n  }\r\n\r\n  /**\r\n   * @description Load item from cache if it's in cache or load from origin observable\r\n   * @param {string} key - Unique key\r\n   * @param {any} observable - Observable with data\r\n   * @param {string} [groupKey] - group key\r\n   * @param {number} [ttl] - TTL in seconds\r\n   * @param {string} [delayType='expired']\r\n   * @param {string} [metaKey] - property on T to which to assign meta data\r\n   * @return {Observable<any>} - data from cache or origin observable\r\n   */\r\n  loadFromDelayedObservable<T = any>(\r\n    key: string,\r\n    observable: Observable<T>,\r\n    groupKey?: string,\r\n    ttl: number = this.ttl,\r\n    delayType: string = 'expired',\r\n    metaKey?: string\r\n  ): Observable<T> {\r\n    if (!this.cacheEnabled) return observable;\r\n\r\n    const observableSubject = new Subject<T>();\r\n    observable = observable.pipe(share());\r\n\r\n    const subscribeOrigin = () => {\r\n      observable.subscribe(\r\n        res => {\r\n          this.saveItem(key, res, groupKey, ttl);\r\n          observableSubject.next(res);\r\n          observableSubject.complete();\r\n        },\r\n        err => {\r\n          observableSubject.error(err);\r\n        },\r\n        () => {\r\n          observableSubject.complete();\r\n        }\r\n      );\r\n    };\r\n\r\n    this.getItem<T>(key)\r\n      .then(data => {\r\n        if (metaKey) {\r\n          data[metaKey] = data[metaKey] || {};\r\n          data[metaKey].fromCache = true;\r\n        }\r\n        observableSubject.next(data);\r\n\r\n        if (delayType === 'all') {\r\n          subscribeOrigin();\r\n        } else {\r\n          observableSubject.complete();\r\n        }\r\n      })\r\n      .catch(e => {\r\n        this.getRawItem<T>(key)\r\n          .then(res => {\r\n            let result = CacheService.decodeRawData(res);\r\n            if (metaKey) {\r\n              result[metaKey] = result[metaKey] || {};\r\n              result[metaKey].fromCache = true;\r\n            }\r\n            observableSubject.next(result);\r\n            subscribeOrigin();\r\n          })\r\n          .catch(() => subscribeOrigin());\r\n      });\r\n\r\n    return observableSubject.asObservable();\r\n  }\r\n\r\n  /**\r\n   * Perform complete cache clear\r\n   * @return {Promise<any>}\r\n   */\r\n  clearAll(): Promise<any> {\r\n    if (!this.cacheEnabled) {\r\n      throw new Error(MESSAGES[2]);\r\n    }\r\n\r\n    return this.resetDatabase();\r\n  }\r\n\r\n  /**\r\n   * @description Remove all expired items from cache\r\n   * @param {boolean} ignoreOnlineStatus -\r\n   * @return {Promise<any>} - query promise\r\n   */\r\n  async clearExpired(ignoreOnlineStatus = false): Promise<any> {\r\n    if (!this.cacheEnabled) {\r\n      throw new Error(MESSAGES[2]);\r\n    }\r\n\r\n    if (!this.isOnline() && !ignoreOnlineStatus) {\r\n      throw new Error(MESSAGES[4]);\r\n    }\r\n\r\n    let items = await this._storage.all();\r\n    let datetime = new Date().getTime();\r\n\r\n    return Promise.all(\r\n      items\r\n      .filter(item => item.expires < datetime)\r\n      .map(item => this.removeItem(item.key))\r\n    );\r\n  }\r\n\r\n  /**\r\n   * @description Remove all item with specified group\r\n   * @param {string} groupKey - group key\r\n   * @return {Promise<any>} - query promise\r\n   */\r\n  async clearGroup(groupKey: string): Promise<any> {\r\n    if (!this.cacheEnabled) {\r\n      throw new Error(MESSAGES[2]);\r\n    }\r\n\r\n    let items = await this._storage.all();\r\n\r\n    return Promise.all(\r\n      items\r\n      .filter(item => item.groupKey === groupKey)\r\n      .map(item => this.removeItem(item.key))\r\n    );\r\n  }\r\n}\r\n"]}